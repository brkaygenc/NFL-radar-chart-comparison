<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Stats Visualizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>NFL PLAYER STATS COMPARISON</h1>
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search for a player...">
                <select id="positionFilter">
                    <option value="QB">QB</option>
                    <option value="WR">WR</option>
                    <option value="RB">RB</option>
                    <option value="TE">TE</option>
                    <option value="K">K</option>
                    <option value="LB">LB</option>
                    <option value="DB">DB</option>
                    <option value="DL">DL</option>
                </select>
                <button onclick="handleSearch()" class="search-btn">Search</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="player-tags">
            <!-- Player comparison tags will be displayed here -->
        </div>

        <div class="charts-container">
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <script>
        let chart = null;
        const searchInput = document.getElementById('searchInput');
        const positionFilter = document.getElementById('positionFilter');
        const searchResults = document.getElementById('searchResults');
        const selectedPlayers = new Set();
        
        async function handleSearch() {
            const query = searchInput.value.trim();
            const position = positionFilter.value;
            
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`/api/search?name=${encodeURIComponent(query)}&position=${encodeURIComponent(position)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to search players');
                }
                
                displaySearchResults(data);
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        function displaySearchResults(players) {
            if (!players || players.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No players found</div>';
                return;
            }
            
            searchResults.innerHTML = players
                .filter(player => !selectedPlayers.has(player.playerid))
                .map(player => `
                    <div class="player-card" onclick="addPlayer(${JSON.stringify(player)})">
                        <div class="player-info">
                            <span class="player-name">${player.playername}</span>
                            <span class="player-details">${player.position} | ${player.team}</span>
                        </div>
                        <div class="player-stats">
                            <span>Pass TDs: ${player.passingtds}</span>
                            <span>Rush TDs: ${player.rushingtds}</span>
                            <span>Total Points: ${player.totalpoints}</span>
                        </div>
                    </div>
                `).join('');
        }

        function addPlayer(player) {
            if (selectedPlayers.has(player.playerid)) {
                return;
            }
            
            if (selectedPlayers.size >= 5) {
                alert('Maximum 5 players can be compared at once');
                return;
            }
            
            selectedPlayers.add(player.playerid);
            updateChart([...selectedPlayers].map(id => 
                document.querySelector(`[data-playerid="${id}"]`).dataset.player
            ));
            searchResults.innerHTML = '';
            searchInput.value = '';
        }

        function updateChart(players) {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            const datasets = players.map((player, index) => ({
                label: player.playername,
                data: [
                    player.passingyards / 100, // Scale down for better visualization
                    player.passingtds * 10,    // Scale up for better visualization
                    player.rushingyards / 10,   // Scale down for better visualization
                    player.rushingtds * 10,     // Scale up for better visualization
                    player.interceptions * -5,   // Negative impact
                    player.totalpoints
                ],
                borderColor: getColor(index),
                backgroundColor: getColor(index, 0.2),
                fill: true
            }));

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'Passing Yards (÷100)',
                        'Passing TDs (×10)',
                        'Rushing Yards (÷10)',
                        'Rushing TDs (×10)',
                        'Interceptions (×-5)',
                        'Total Points'
                    ],
                    datasets: datasets
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            min: -50,
                            max: 500
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function getColor(index, alpha = 1) {
            const colors = [
                `rgba(255, 99, 132, ${alpha})`,
                `rgba(54, 162, 235, ${alpha})`,
                `rgba(255, 206, 86, ${alpha})`,
                `rgba(75, 192, 192, ${alpha})`,
                `rgba(153, 102, 255, ${alpha})`
            ];
            return colors[index % colors.length];
        }

        // Debounce the search to avoid too many API calls
        const debouncedSearch = debounce(handleSearch, 300);
        searchInput.addEventListener('input', debouncedSearch);
        positionFilter.addEventListener('change', debouncedSearch);

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>