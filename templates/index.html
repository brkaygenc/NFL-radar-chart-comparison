<!DOCTYPE html>
<html>
<head>
    <title>NFL Player Stats Comparison</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>NFL PLAYER STATS COMPARISON</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search for a player...">
                <select id="positionFilter">
                    <option value="QB">QB</option>
                    <option value="RB">RB</option>
                    <option value="WR">WR</option>
                    <option value="TE">TE</option>
                    <option value="K">K</option>
                </select>
                <button class="search-btn">SEARCH</button>
            </div>
            
            <div id="searchResults" class="search-results"></div>
        </div>

        <div id="selectedPlayers" class="player-tags"></div>
        
        <div class="charts-container">
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const positionFilter = document.getElementById('positionFilter');
        const searchResults = document.getElementById('searchResults');
        const selectedPlayersDiv = document.getElementById('selectedPlayers');
        const selectedPlayers = new Set();
        const selectedPlayersData = [];
        let chart = null;

        const COLORS = [
            { border: '#ff4d4d', background: 'rgba(255, 77, 77, 0.2)' },
            { border: '#4da6ff', background: 'rgba(77, 166, 255, 0.2)' },
            { border: '#4dff4d', background: 'rgba(77, 255, 77, 0.2)' },
            { border: '#ffff4d', background: 'rgba(255, 255, 77, 0.2)' },
            { border: '#ff4dff', background: 'rgba(255, 77, 255, 0.2)' }
        ];

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        document.querySelector('.search-btn').addEventListener('click', handleSearch);

        async function handleSearch() {
            const query = searchInput.value.trim();
            const position = positionFilter.value;
            
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`/api/search?name=${encodeURIComponent(query)}&position=${encodeURIComponent(position)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch players');
                }
                const data = await response.json();
                displaySearchResults(data);
            } catch (error) {
                searchResults.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        function displaySearchResults(players) {
            if (!players || players.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No players found</div>';
                return;
            }
            
            searchResults.innerHTML = players
                .filter(player => !selectedPlayers.has(player.playerid))
                .map(player => `
                    <div class="player-card">
                        <div class="player-info">
                            <div class="player-name">${player.playername}</div>
                            <div class="player-details">${positionFilter.value} • ${player.team}</div>
                        </div>
                        <button class="add-btn" onclick="addPlayer(${JSON.stringify(player).replace(/"/g, '&quot;')})">
                            Add to Compare
                        </button>
                    </div>
                `).join('');
        }

        function addPlayer(player) {
            if (selectedPlayers.has(player.playerid)) return;
            if (selectedPlayers.size >= 5) {
                alert('Maximum 5 players can be compared');
                return;
            }
            
            selectedPlayers.add(player.playerid);
            selectedPlayersData.push(player);
            updateChart();
            updateSelectedPlayersList();
            searchResults.innerHTML = '';
            searchInput.value = '';
        }

        function removePlayer(playerId) {
            selectedPlayers.delete(playerId);
            const index = selectedPlayersData.findIndex(p => p.playerid === playerId);
            if (index > -1) {
                selectedPlayersData.splice(index, 1);
            }
            updateChart();
            updateSelectedPlayersList();
        }

        function updateSelectedPlayersList() {
            selectedPlayersDiv.innerHTML = selectedPlayersData
                .map((player, index) => `
                    <div class="player-tag" style="background: ${COLORS[index].background}; border-color: ${COLORS[index].border}">
                        <span>${player.playername} ${positionFilter.value} • ${player.team}</span>
                        <button class="remove-btn" onclick="removePlayer('${player.playerid}')">&times;</button>
                    </div>
                `).join('');
        }

        function getPlayerStats(player) {
            if (positionFilter.value === 'K') {
                return {
                    labels: ['Field Goals', 'FG Attempts', 'Extra Points', 'XP Attempts', 'Total Points'],
                    data: [
                        player.fieldgoals || 0,
                        player.fgattempts || 0,
                        player.extrapoints || 0,
                        player.xpattempts || 0,
                        player.totalpoints || 0
                    ]
                };
            }
            
            // For other positions (QB, RB, WR, TE)
            return {
                labels: ['Total Yards', 'Touchdowns', 'Receptions', 'Targets', 'Total Points'],
                data: [
                    (player.passingyards || 0) + (player.rushingyards || 0) + (player.receivingyards || 0),
                    (player.passingtds || 0) + (player.rushingtds || 0) + (player.receivingtds || 0),
                    player.receptions || 0,
                    player.targets || 0,
                    player.totalpoints || 0
                ]
            };
        }

        function updateChart() {
            if (selectedPlayersData.length === 0) {
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                return;
            }

            const firstPlayer = selectedPlayersData[0];
            const stats = getPlayerStats(firstPlayer);
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            const datasets = selectedPlayersData.map((player, index) => {
                const playerStats = getPlayerStats(player);
                return {
                    label: player.playername,
                    data: playerStats.data,
                    borderColor: COLORS[index].border,
                    backgroundColor: COLORS[index].background,
                    borderWidth: 2,
                    pointBackgroundColor: COLORS[index].border,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: COLORS[index].border,
                    fill: true
                };
            });

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: stats.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#fff'
                            },
                            ticks: {
                                color: '#fff',
                                backdropColor: 'transparent'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>