<!DOCTYPE html>
<html>
<head>
    <title>NFL Player Stats Comparison</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>NFL PLAYER STATS COMPARISON</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search for a player...">
                <select id="positionFilter" class="position-filter">
                    <optgroup label="Offense">
                        <option value="QB">QB</option>
                        <option value="RB">RB</option>
                        <option value="WR">WR</option>
                        <option value="TE">TE</option>
                    </optgroup>
                    <optgroup label="Defense">
                        <option value="LB">LB</option>
                        <option value="DB">DB</option>
                        <option value="DL">DL</option>
                    </optgroup>
                </select>
                <button class="search-btn">SEARCH</button>
            </div>
            
            <div id="searchResults" class="search-results"></div>
        </div>

        <div id="selectedPlayers" class="player-tags"></div>
        
        <div class="charts-container">
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const positionFilter = document.getElementById('positionFilter');
        const searchResults = document.getElementById('searchResults');
        const selectedPlayersDiv = document.getElementById('selectedPlayers');
        const selectedPlayers = new Set();
        const selectedPlayersData = [];
        let chart = null;

        const COLORS = [
            { border: '#ff4d4d', background: 'rgba(255, 77, 77, 0.2)' },
            { border: '#4da6ff', background: 'rgba(77, 166, 255, 0.2)' },
            { border: '#4dff4d', background: 'rgba(77, 255, 77, 0.2)' },
            { border: '#ffff4d', background: 'rgba(255, 255, 77, 0.2)' },
            { border: '#ff4dff', background: 'rgba(255, 77, 255, 0.2)' }
        ];

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        document.querySelector('.search-btn').addEventListener('click', handleSearch);

        async function handleSearch() {
            const query = searchInput.value.trim();
            const position = positionFilter.value;
            
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`/api/search?name=${encodeURIComponent(query)}&position=${encodeURIComponent(position)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch players');
                }
                const data = await response.json();
                displaySearchResults(data);
            } catch (error) {
                searchResults.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        function displaySearchResults(players) {
            searchResults.innerHTML = '';
            if (players.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No players found</div>';
                return;
            }

            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.innerHTML = `
                    <div class="player-info">
                        <div class="player-name">${player.playername}</div>
                        <div class="player-details">${player.team} • ${player.position}</div>
                    </div>
                    <button class="add-btn" onclick="addPlayer(${JSON.stringify(player).replace(/"/g, '&quot;')})">
                        Add to Compare
                    </button>
                `;
                searchResults.appendChild(div);
            });
        }

        function addPlayer(player) {
            if (selectedPlayers.has(player.playerid)) return;
            if (selectedPlayers.size >= 5) {
                alert('Maximum 5 players can be compared');
                return;
            }
            
            selectedPlayers.add(player.playerid);
            selectedPlayersData.push(player);
            updateChart();
            updateSelectedPlayersList();
            searchResults.innerHTML = '';
            searchInput.value = '';
        }

        function removePlayer(playerId) {
            selectedPlayers.delete(playerId);
            const index = selectedPlayersData.findIndex(p => p.playerid === playerId);
            if (index > -1) {
                selectedPlayersData.splice(index, 1);
            }
            updateChart();
            updateSelectedPlayersList();
        }

        function updateSelectedPlayersList() {
            selectedPlayersDiv.innerHTML = selectedPlayersData
                .map((player, index) => `
                    <div class="player-tag" style="background: ${COLORS[index].background}; border-color: ${COLORS[index].border}">
                        <span>${player.playername} ${player.position} • ${player.team}</span>
                        <button class="remove-btn" onclick="removePlayer('${player.playerid}')">&times;</button>
                    </div>
                `).join('');
        }

        function getPlayerStats(player) {
            switch(positionFilter.value) {
                case 'QB':
                    return {
                        labels: ['Passing Yards', 'Passing TDs', 'Rushing Yards', 'Rushing TDs', 'Interceptions'],
                        data: [
                            parseFloat(player.passingyards) || 0,
                            parseFloat(player.passingtds) || 0,
                            parseFloat(player.rushingyards) || 0,
                            parseFloat(player.rushingtds) || 0,
                            parseFloat(player.interceptions) || 0
                        ]
                    };
                case 'WR':
                case 'TE':
                    return {
                        labels: ['Receiving Yards', 'Receiving TDs', 'Receptions', 'Targets', 'Total Points'],
                        data: [
                            parseFloat(player.receivingyards) || 0,
                            parseFloat(player.receivingtds) || 0,
                            parseFloat(player.receptions) || 0,
                            parseFloat(player.targets) || 0,
                            parseFloat(player.totalpoints) || 0
                        ]
                    };
                case 'RB':
                    return {
                        labels: ['Rushing Yards', 'Rushing TDs', 'Receptions', 'Receiving Yards', 'Total Points'],
                        data: [
                            parseFloat(player.rushingyards) || 0,
                            parseFloat(player.rushingtds) || 0,
                            parseFloat(player.receptions) || 0,
                            parseFloat(player.receivingyards) || 0,
                            parseFloat(player.totalpoints) || 0
                        ]
                    };
                case 'LB':
                case 'DB':
                case 'DL':
                    return {
                        labels: ['Tackles', 'Sacks', 'Interceptions', 'Passes Defended', 'Total Points'],
                        data: [
                            parseFloat(player.tackles) || 0,
                            parseFloat(player.sacks) || 0,
                            parseFloat(player.interceptions) || 0,
                            parseFloat(player.passesdefended) || 0,
                            parseFloat(player.totalpoints) || 0
                        ]
                    };
                default:
                    return {
                        labels: ['Total Points'],
                        data: [parseFloat(player.totalpoints) || 0]
                    };
            }
        }

        function updateChart() {
            if (selectedPlayersData.length === 0) {
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                return;
            }

            const firstPlayer = selectedPlayersData[0];
            const stats = getPlayerStats(firstPlayer);
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            const datasets = selectedPlayersData.map((player, index) => {
                const playerStats = getPlayerStats(player);
                return {
                    label: player.playername,
                    data: playerStats.data,
                    borderColor: COLORS[index].border,
                    backgroundColor: COLORS[index].background,
                    borderWidth: 2,
                    pointBackgroundColor: COLORS[index].border,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: COLORS[index].border,
                    fill: true
                };
            });

            if (chart) {
                chart.destroy();
            }

            // Calculate max values for each stat
            const maxValues = stats.data.map((_, statIndex) => {
                return Math.max(...selectedPlayersData.map(p => {
                    const playerStats = getPlayerStats(p);
                    return playerStats.data[statIndex];
                }));
            });

            chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: stats.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#fff',
                                font: {
                                    size: 14
                                }
                            },
                            suggestedMin: 0,
                            suggestedMax: Math.max(...maxValues),
                            ticks: {
                                color: '#fff',
                                backdropColor: 'transparent',
                                stepSize: Math.ceil(Math.max(...maxValues) / 5)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>